# main_app.py

import streamlit as st
import pandas as pd
from prostocks_connector import ProStocksAPI
from dashboard_logic import load_settings, save_settings, load_credentials
from datetime import datetime, time


# === Load and Apply Settings (only once)
if "settings_loaded" not in st.session_state:
    st.session_state.update(load_settings())
    st.session_state["settings_loaded"] = True

# === Load Credentials from .env
creds = load_credentials()


# ğŸ” Sidebar Login
with st.sidebar:
    st.header("ğŸ” ProStocks Login")
    with st.form("ProStocksLoginForm"):
        uid = st.text_input("User ID", value=creds["uid"])
        pwd = st.text_input("Password", type="password", value=creds["pwd"])
        factor2 = st.text_input("PAN / DOB", value=creds["factor2"])
        vc = st.text_input("Vendor Code", value=creds["vc"] or uid)
        api_key = st.text_input("API Key", type="password", value=creds["api_key"])
        imei = st.text_input("MAC Address", value=creds["imei"])
        base_url = st.text_input("Base URL", value=creds["base_url"])
        apkversion = st.text_input("APK Version", value=creds["apkversion"])

        submitted = st.form_submit_button("ğŸ” Login")

        if submitted:
            try:
                ps_api = ProStocksAPI(uid, pwd, factor2, vc, api_key, imei, base_url, apkversion)
                success, msg = ps_api.login()
                if success:
                    st.session_state["ps_api"] = ps_api
                    st.success("âœ… Login Successful")
                    st.rerun()
                else:
                    st.error(f"âŒ Login failed: {msg}")
            except Exception as e:
                st.error(f"âŒ Exception: {e}")

# ğŸ”“ Logout button if already logged in
if "ps_api" in st.session_state:
    st.markdown("---")
    if st.button("ğŸ”“ Logout"):
        del st.session_state["ps_api"]
        st.success("âœ… Logged out successfully")
        st.rerun()


        
            



        
